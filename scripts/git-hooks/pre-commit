#!/usr/bin/env bash
# Git pre-commit hook
# Ëá™ÂãïÁöÑ„Å´„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å

set -e

# „Ç´„É©„Éº„Ç≥„Éº„Éâ
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
NC=$'\033[0m'

print_error() { printf "${RED}[PRE-COMMIT ERROR]${NC} %s\n" "$1" >&2; }
print_warn() { printf "${YELLOW}[PRE-COMMIT WARN]${NC} %s\n" "$1" >&2; }
print_ok() { printf "${GREEN}[PRE-COMMIT OK]${NC} %s\n" "$1" >&2; }

echo ""
echo "üîí Running pre-commit checks..."
echo ""

FAILED=0

# ==========================================
# 1. Ê©üÂØÜÊÉÖÂ†±„Çπ„Ç≠„É£„É≥
# ==========================================
echo "[1/3] Security scan..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")

if [ -n "$STAGED_FILES" ]; then
    # .env„Éï„Ç°„Ç§„É´„ÉÅ„Çß„ÉÉ„ÇØ
    if echo "$STAGED_FILES" | grep -vE '\.env\.example$' | grep -qE '\.env$|\.env\.'; then
        print_error ".env file is staged for commit"
        print_error "Never commit .env files containing secrets"
        FAILED=1
    fi

    # API„Ç≠„Éº„Éë„Çø„Éº„É≥Ê§úÂá∫
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            # Skip documentation, configuration files, and scripts directory
            case "$file" in
                *.md|*.yml|*.yaml|.gitignore|.secretsignore|Makefile|scripts/*)
                    continue
                    ;;
            esac

            # OpenAI API keys
            if grep -nE 'sk-proj-[a-zA-Z0-9_-]{20,}' "$file" 2>/dev/null | head -n 1; then
                print_error "OpenAI Project API key detected in: $file"
                FAILED=1
            fi

            if grep -nE 'sk-[a-zA-Z0-9_-]{20,}' "$file" 2>/dev/null | head -n 1; then
                print_error "OpenAI API key detected in: $file"
                FAILED=1
            fi

            # Gemini API keys
            if grep -nE 'AIzaSy[a-zA-Z0-9_-]{33}' "$file" 2>/dev/null | head -n 1; then
                print_error "Gemini API key detected in: $file"
                FAILED=1
            fi

            # Anthropic API keys
            if grep -nE 'sk-ant-[a-zA-Z0-9_-]{20,}' "$file" 2>/dev/null | head -n 1; then
                print_error "Anthropic API key detected in: $file"
                FAILED=1
            fi

            # AWS keys
            if grep -nE 'AKIA[0-9A-Z]{16}' "$file" 2>/dev/null | head -n 1; then
                print_error "AWS Access Key detected in: $file"
                FAILED=1
            fi

            # GitHub tokens
            if grep -nE 'ghp_[A-Za-z0-9]{36}' "$file" 2>/dev/null | head -n 1; then
                print_error "GitHub Personal Access Token detected in: $file"
                FAILED=1
            fi

            # Private keys
            if grep -nE 'BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY' "$file" 2>/dev/null | head -n 1; then
                print_error "Private key detected in: $file"
                FAILED=1
            fi
        fi
    done <<< "$STAGED_FILES"
fi

if [ $FAILED -eq 0 ]; then
    print_ok "No secrets detected"
fi

# ==========================================
# 2. ‰∏çË¶Å„Éï„Ç°„Ç§„É´„ÉÅ„Çß„ÉÉ„ÇØ
# ==========================================
echo "[2/3] Unwanted files check..."

UNWANTED_FOUND=0

if echo "$STAGED_FILES" | grep -qE '__pycache__|\.pyc$|\.pyo$|\.backup$|\.bak$'; then
    print_error "Unwanted files staged for commit:"
    echo "$STAGED_FILES" | grep -E '__pycache__|\.pyc$|\.pyo$|\.backup$|\.bak$' | sed 's/^/  /'
    print_error "Please unstage these files:"
    echo "  git rm --cached <file>"
    UNWANTED_FOUND=1
    FAILED=1
fi

if [ $UNWANTED_FOUND -eq 0 ]; then
    print_ok "No unwanted files"
fi

# ==========================================
# 3. Python lintingÔºàoptionalÔºâ
# ==========================================
echo "[3/3] Code quality check..."

PYTHON_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ] && command -v ruff >/dev/null 2>&1; then
    if ! echo "$PYTHON_FILES" | xargs ruff check --quiet 2>/dev/null; then
        print_warn "Ruff found issues (not blocking commit)"
    else
        print_ok "Ruff check passed"
    fi
elif [ -n "$PYTHON_FILES" ]; then
    print_warn "Ruff not installed (skipping lint)"
else
    print_ok "No Python files to lint"
fi

# ==========================================
# ÁµêÊûú
# ==========================================
echo ""

if [ $FAILED -eq 1 ]; then
    print_error "Pre-commit hook failed"
    echo ""
    echo "To bypass this hook (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    print_ok "All pre-commit checks passed"
    echo ""
    exit 0
fi
