name: Security Scan

on:
  push:
    branches: [ main, develop, "feature/**" ]
  pull_request:
    branches: [ main, develop, "feature/**" ]
  schedule:
    # 毎日午前2時（UTC）に実行
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 全履歴を取得（gitleaks用）

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Custom secret patterns scan
      run: |
        echo "=== Custom Secret Scan ==="

        # 除外パターンを構築（.secretsignoreから）
        EXCLUDE_ARGS=""
        if [ -f .secretsignore ]; then
          while IFS= read -r line || [ -n "$line" ]; do
            # コメント行と空行をスキップ
            if [[ "$line" =~ ^[[:space:]]*# ]] || [[ -z "$line" ]]; then
              continue
            fi
            # ディレクトリやワイルドカードパターンをスキップ（ファイルパスのみ対象）
            if [[ "$line" =~ / ]] || [[ "$line" =~ \* ]]; then
              continue
            fi
            # git grep の除外パターンに追加
            EXCLUDE_ARGS="$EXCLUDE_ARGS -- ':!${line}'"
          done < .secretsignore
        fi

        # ドキュメントファイルを明示的に除外
        EXCLUDE_ARGS="$EXCLUDE_ARGS -- ':!RESEARCH_TOOL_SETUP.md' -- ':!mcp-chatgpt-server/README.md' -- ':!.claude/commands/research.md' -- ':!.claude/retrospective.md' -- ':!README.md'"

        # OpenAI API keys
        OPENAI_FOUND=$(eval "git grep -nE 'sk-proj-[a-zA-Z0-9_-]{20,}' $EXCLUDE_ARGS" || true)
        if [ -n "$OPENAI_FOUND" ]; then
          echo "❌ OpenAI API key detected:"
          echo "$OPENAI_FOUND"
          exit 1
        fi

        # Gemini API keys
        GEMINI_FOUND=$(eval "git grep -nE 'AIzaSy[a-zA-Z0-9_-]{33}' $EXCLUDE_ARGS" || true)
        if [ -n "$GEMINI_FOUND" ]; then
          echo "❌ Gemini API key detected:"
          echo "$GEMINI_FOUND"
          exit 1
        fi

        # Anthropic API keys
        ANTHROPIC_FOUND=$(eval "git grep -nE 'sk-ant-[a-zA-Z0-9_-]{20,}' $EXCLUDE_ARGS" || true)
        if [ -n "$ANTHROPIC_FOUND" ]; then
          echo "❌ Anthropic API key detected:"
          echo "$ANTHROPIC_FOUND"
          exit 1
        fi

        echo "✅ No secrets detected"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate
      continue-on-error: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install safety
      run: pip install safety

    - name: Run Python dependency scan
      run: |
        pip install -r requirements-dev.txt
        safety check --json
      continue-on-error: true

  gitignore-validation:
    name: .gitignore Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate .gitignore patterns
      run: |
        echo "=== Validating .gitignore ==="

        REQUIRED_PATTERNS=(
          "__pycache__/"
          "*.pyc"
          ".env"
          "*.backup"
          "*.bak"
          "node_modules/"
        )

        FAILED=0
        for pattern in "${REQUIRED_PATTERNS[@]}"; do
          if grep -qF "$pattern" .gitignore; then
            echo "✅ $pattern"
          else
            echo "❌ Missing: $pattern"
            FAILED=1
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "❌ .gitignore validation failed"
          echo "Please add missing patterns to .gitignore"
          exit 1
        fi

        echo ""
        echo "✅ .gitignore validation passed"

    - name: Check for unwanted tracked files
      run: |
        echo "=== Checking for unwanted tracked files ==="

        UNWANTED_FILES=$(git ls-files | grep -E '(__pycache__|\.pyc$|\.pyo$|\.backup$|\.bak$|\.env$)' || true)

        if [ -n "$UNWANTED_FILES" ]; then
          echo "❌ Unwanted files are tracked:"
          echo "$UNWANTED_FILES"
          exit 1
        fi

        echo "✅ No unwanted files tracked"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, gitignore-validation]
    if: always()

    steps:
    - name: Check all security scans
      run: |
        if [ "${{ needs.secret-scan.result }}" != "success" ] || \
           [ "${{ needs.dependency-scan.result }}" != "success" ] || \
           [ "${{ needs.gitignore-validation.result }}" != "success" ]; then
          echo "❌ Some security checks failed"
          exit 1
        else
          echo "✅ All security checks passed"
        fi
