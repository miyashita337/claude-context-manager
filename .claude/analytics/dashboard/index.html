<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #1e1e2e; --surface: #2a2a3e; --border: #3a3a5c;
    --text: #cdd6f4; --muted: #6c7086; --accent: #89b4fa;
    --red: #f38ba8; --yellow: #f9e2af; --green: #a6e3a1;
    --orange: #fab387;
  }
  body { background: var(--bg); color: var(--text); font: 14px/1.5 'Segoe UI', system-ui, sans-serif; }

  /* â”€â”€ Layout â”€â”€ */
  header { display:flex; align-items:center; justify-content:space-between;
    padding:12px 20px; background:var(--surface); border-bottom:1px solid var(--border);
    position:sticky; top:0; z-index:100; }
  header h1 { font-size:16px; font-weight:600; color:var(--accent); }
  .tab-bar { display:flex; gap:4px; }
  .tab { padding:6px 14px; border:1px solid var(--border); border-radius:6px;
    cursor:pointer; background:transparent; color:var(--muted); font-size:13px;
    transition:all .15s; }
  .tab.active, .tab:hover { background:var(--accent); color:#1e1e2e; border-color:var(--accent); }
  .gear-btn { background:none; border:1px solid var(--border); border-radius:6px;
    padding:6px 10px; cursor:pointer; color:var(--muted); font-size:16px;
    transition:all .15s; }
  .gear-btn:hover { color:var(--text); border-color:var(--text); }

  main { padding:20px; max-width:1400px; margin:0 auto; }
  .panel { display:none; }
  .panel.active { display:block; }

  /* â”€â”€ Cards â”€â”€ */
  .cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:12px; margin-bottom:20px; }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:10px;
    padding:16px; }
  .card-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px; }
  .card-value { font-size:24px; font-weight:700; }
  .card-value.red { color:var(--red); }
  .card-value.yellow { color:var(--yellow); }
  .card-value.green { color:var(--green); }
  .card-value.blue { color:var(--accent); }
  .card-sub { font-size:11px; color:var(--muted); margin-top:4px; }

  /* â”€â”€ Charts row â”€â”€ */
  .charts-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
  .chart-box { background:var(--surface); border:1px solid var(--border);
    border-radius:10px; padding:16px; }
  .chart-box h3 { font-size:13px; color:var(--muted); margin-bottom:12px; }
  .chart-box canvas { width:100% !important; }

  /* â”€â”€ Timeline â”€â”€ */
  .timeline-grid { display:flex; flex-direction:column; gap:8px; }
  .tl-row { display:grid; grid-template-columns:130px 1fr 80px 80px 80px;
    gap:8px; align-items:center; font-size:12px; padding:10px 14px;
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    cursor:pointer; transition:border-color .15s; }
  .tl-row:hover { border-color:var(--accent); }
  .tl-bar-wrap { height:16px; background:var(--bg); border-radius:4px; overflow:hidden; }
  .tl-bar { height:100%; border-radius:4px; transition:width .3s; }
  .tl-bar.red    { background:var(--red); }
  .tl-bar.yellow { background:var(--yellow); }
  .tl-bar.green  { background:var(--green); }
  .tl-header { display:grid; grid-template-columns:130px 1fr 80px 80px 80px;
    gap:8px; padding:6px 14px; font-size:11px; color:var(--muted);
    text-transform:uppercase; letter-spacing:.05em; }
  .badge { display:inline-block; padding:2px 7px; border-radius:4px; font-size:10px; font-weight:600; }
  .badge.red    { background:rgba(243,139,168,.2); color:var(--red); }
  .badge.yellow { background:rgba(249,226,175,.2); color:var(--yellow); }
  .badge.green  { background:rgba(166,227,161,.2); color:var(--green); }

  /* â”€â”€ Tree â”€â”€ */
  .tree { display:flex; flex-direction:column; gap:4px; }
  .tree-node { background:var(--surface); border:1px solid var(--border);
    border-radius:8px; overflow:hidden; }
  .tree-header { display:grid; grid-template-columns:1fr auto auto auto auto;
    gap:12px; align-items:center; padding:10px 14px; cursor:pointer;
    transition:background .15s; }
  .tree-header:hover { background:rgba(137,180,250,.05); }
  .tree-expand { font-size:10px; color:var(--muted); transition:transform .2s; }
  .tree-expand.open { transform:rotate(90deg); }
  .tree-children { padding:0 8px 8px 24px; display:none; flex-direction:column; gap:4px; }
  .tree-children.open { display:flex; }
  .tree-leaf { display:grid; grid-template-columns:1fr auto auto; gap:12px;
    padding:7px 10px; border-radius:6px; border:1px solid var(--border);
    font-size:12px; background:var(--bg); align-items:center; }
  .tool-chip { display:inline-block; padding:1px 8px; border-radius:99px; font-size:11px;
    background:rgba(137,180,250,.15); color:var(--accent); }
  .anomaly-chip { display:inline-block; padding:1px 8px; border-radius:99px; font-size:11px;
    position:relative; cursor:help; }
  .anomaly-chip.high { background:rgba(243,139,168,.2); color:var(--red); }
  .anomaly-chip.medium { background:rgba(249,226,175,.2); color:var(--yellow); }
  .anomaly-tip {
    display:none; position:fixed;
    background:#13131f; border:1px solid var(--border); border-radius:8px;
    padding:12px 14px; width:300px; z-index:9999; font-size:12px; line-height:1.7;
    white-space:normal; pointer-events:none; box-shadow:0 4px 20px rgba(0,0,0,.5);
  }
  .anomaly-tip ul { margin:3px 0 6px; padding-left:16px; }
  .anomaly-tip li { margin-bottom:2px; }
  .tip-title { font-weight:700; font-size:13px; margin-bottom:4px; color:var(--text); }
  .tip-threshold { font-size:11px; color:var(--muted); margin-bottom:8px; }
  .tip-section { font-size:11px; font-weight:600; margin-bottom:2px; }
  .val { color:var(--muted); }

  /* â”€â”€ Settings Modal â”€â”€ */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
    z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:24px; width:420px; max-width:90vw; }
  .modal h2 { font-size:16px; margin-bottom:20px; color:var(--accent); }
  .field { margin-bottom:16px; }
  .field label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  .field input { width:100%; background:var(--bg); border:1px solid var(--border);
    border-radius:6px; padding:8px 12px; color:var(--text); font-size:14px; }
  .field input:focus { outline:none; border-color:var(--accent); }
  .modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:20px; }
  .btn { padding:8px 16px; border-radius:6px; cursor:pointer; font-size:13px; border:none; }
  .btn-primary { background:var(--accent); color:#1e1e2e; font-weight:600; }
  .btn-secondary { background:transparent; color:var(--muted);
    border:1px solid var(--border); }
  .btn:hover { opacity:.85; }

  /* â”€â”€ Bottleneck â”€â”€ */
  .bn-score-badge { display:inline-block; padding:1px 7px; border-radius:4px;
    font-size:10px; font-weight:700; font-family:monospace; margin-left:6px; }
  .bn-score-badge.bn-high   { background:rgba(243,139,168,.2); color:var(--red); }
  .bn-score-badge.bn-medium { background:rgba(249,226,175,.2); color:var(--yellow); }
  .bn-score-badge.bn-low    { background:rgba(108,112,134,.2); color:var(--muted); }

  .bn-report { background:var(--bg); border:1px solid var(--border); border-radius:8px;
    margin:4px 0; overflow:hidden; }
  .bn-report-header { display:flex; align-items:center; gap:8px; padding:8px 12px;
    cursor:pointer; font-size:12px; color:var(--muted); transition:background .15s; }
  .bn-report-header:hover { background:rgba(137,180,250,.05); }
  .bn-report-header .bn-arrow { font-size:10px; transition:transform .2s; }
  .bn-report-header .bn-arrow.open { transform:rotate(90deg); }
  .bn-report-body { display:none; padding:0 12px 10px 28px; font-size:12px; }
  .bn-report-body.open { display:block; }

  .bn-issue-group { margin-bottom:6px; }
  .bn-issue-group summary { cursor:pointer; color:var(--text); font-size:12px; list-style:none; }
  .bn-issue-group summary::before { content:'â–¸ '; color:var(--muted); }
  .bn-issue-group[open] summary::before { content:'â–¾ '; }
  .bn-issue-group .bn-detail { padding:2px 0 2px 16px; color:var(--muted); font-size:11px;
    line-height:1.6; }
  .bn-issue-type { display:inline-block; padding:1px 6px; border-radius:3px;
    font-size:10px; font-weight:600; margin-right:4px; }
  .bn-issue-type.tool_loop          { background:rgba(243,139,168,.15); color:var(--red); }
  .bn-issue-type.large_tool_result  { background:rgba(250,179,135,.15); color:var(--orange); }
  .bn-issue-type.token_spike        { background:rgba(249,226,175,.15); color:var(--yellow); }
  .bn-issue-type.repeated_file_read { background:rgba(137,180,250,.15); color:var(--accent); }

  .bn-top-issues { margin-top:8px; padding-top:6px; border-top:1px solid var(--border); }
  .bn-top-issues .bn-top-label { font-size:11px; font-weight:600; color:var(--orange);
    margin-bottom:4px; }
  .bn-top-issues li { color:var(--muted); font-size:11px; line-height:1.6;
    list-style:disc; margin-left:16px; }

  /* â”€â”€ Reviews â”€â”€ */
  .reviews-list { display:flex; flex-direction:column; gap:8px; }
  .review-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .review-card-header { display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; cursor:pointer; font-size:12px; transition:background .15s; }
  .review-card-header:hover { background:rgba(137,180,250,.05); }
  .review-card-title { font-weight:600; color:var(--text); }
  .review-card-date { font-size:11px; color:var(--muted); }
  .review-card-body { display:none; padding:20px; border-top:1px solid var(--border); }
  .review-card-body.open { display:block; }
  .review-content { font-size:13px; line-height:1.7; color:var(--text); }
  .review-content h1 { font-size:16px; font-weight:700; margin:0 0 12px; color:var(--accent); }
  .review-content h2 { font-size:14px; font-weight:600; margin:16px 0 8px; color:var(--text); border-bottom:1px solid var(--border); padding-bottom:4px; }
  .review-content h3 { font-size:13px; font-weight:600; margin:12px 0 6px; color:var(--yellow); }
  .review-content p { margin:0 0 8px; }
  .review-content code { background:var(--bg); border:1px solid var(--border); border-radius:3px;
    padding:1px 5px; font-family:monospace; font-size:12px; color:var(--accent); }
  .review-content pre { background:var(--bg); border:1px solid var(--border); border-radius:6px;
    padding:12px; overflow-x:auto; margin:8px 0; }
  .review-content pre code { border:none; padding:0; background:none; color:var(--text); }
  .review-content ul, .review-content ol { padding-left:20px; margin:4px 0 8px; }
  .review-content li { margin-bottom:3px; }
  .review-content table { border-collapse:collapse; width:100%; margin:8px 0; font-size:12px; }
  .review-content th, .review-content td { border:1px solid var(--border); padding:5px 10px; text-align:left; }
  .review-content th { background:var(--bg); color:var(--muted); font-weight:600; }
  .review-content hr { border:none; border-top:1px solid var(--border); margin:16px 0; }
  .review-content strong { color:var(--text); font-weight:700; }
  .review-content a { color:var(--accent); text-decoration:none; }
  .review-content a:hover { text-decoration:underline; }
  .review-content blockquote { border-left:3px solid var(--border); margin:8px 0;
    padding:4px 12px; color:var(--muted); font-style:italic; }

  /* â”€â”€ Empty state â”€â”€ */
  .empty { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty code { background:var(--bg); padding:2px 8px; border-radius:4px;
    color:var(--accent); font-size:13px; }
</style>
</head>
<body>

<header>
  <h1>âš¡ Claude Code Analytics</h1>
  <div class="tab-bar">
    <button class="tab active" onclick="showPanel('overview')">Overview</button>
    <button class="tab" onclick="showPanel('timeline')">Timeline</button>
    <button class="tab" onclick="showPanel('tree')">Drilldown</button>
    <button class="tab" onclick="showPanel('reviews')">Reviews</button>
  </div>
  <button class="gear-btn" onclick="openSettings()">âš™ï¸</button>
</header>

<main>
  <!-- â”€â”€ Overview â”€â”€ -->
  <div id="panel-overview" class="panel active">
    <div class="cards" id="stat-cards"></div>
    <div class="charts-row">
      <div class="chart-box">
        <h3>Token Type Breakdown</h3>
        <canvas id="chart-tokens" height="200"></canvas>
      </div>
      <div class="chart-box">
        <h3>Top Tools Used</h3>
        <canvas id="chart-tools" height="200"></canvas>
      </div>
    </div>
    <div class="chart-box" style="margin-bottom:20px">
      <h3>Session Cost (heaviest)</h3>
      <canvas id="chart-sessions" height="120"></canvas>
    </div>
    <div class="charts-row">
      <div class="chart-box">
        <h3>Bottleneck Issue Distribution</h3>
        <canvas id="chart-bn-issues" height="200"></canvas>
      </div>
      <div class="chart-box">
        <h3>Sessions by Bottleneck Score</h3>
        <canvas id="chart-bn-scores" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Timeline â”€â”€ -->
  <div id="panel-timeline" class="panel">
    <div class="tl-header">
      <span>Session</span><span>Token Usage</span>
      <span>Tokens</span><span>Cost</span><span>Status</span>
    </div>
    <div class="timeline-grid" id="timeline-rows"></div>
  </div>

  <!-- â”€â”€ Reviews â”€â”€ -->
  <div id="panel-reviews" class="panel">
    <div class="reviews-list" id="reviews-list"></div>
  </div>

  <!-- â”€â”€ Drilldown Tree â”€â”€ -->
  <div id="panel-tree" class="panel">
    <div style="margin-bottom:12px; font-size:12px; color:var(--muted)">
      Click a session to expand messages â†’ tools
    </div>
    <div class="tree" id="tree-root"></div>
  </div>
</main>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <h2>âš™ï¸ Analytics Settings</h2>
    <div class="field">
      <label>Daily Token Threshold</label>
      <input type="number" id="cfg-tokens" placeholder="70000">
    </div>
    <div class="field">
      <label>Duration Threshold (minutes)</label>
      <input type="number" id="cfg-duration" placeholder="10">
    </div>
    <div class="field">
      <label>Daily Cost Threshold ($)</label>
      <input type="number" id="cfg-cost" step="0.1" placeholder="10">
    </div>
    <div class="field">
      <label>Repetition Threshold (tool calls)</label>
      <input type="number" id="cfg-rep" placeholder="100">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let DATA = null;

async function loadData() {
  // Inline data injected by engine.py (works with file:// protocol)
  if (window.__ANALYTICS_DATA__) {
    DATA = window.__ANALYTICS_DATA__;
    render();
    const h = window.location.hash.slice(1);
    if (h) showPanel(h);
    return;
  }
  try {
    const r = await fetch('analytics.json');
    DATA = await r.json();
    render();
    const h = window.location.hash.slice(1);
    if (h) showPanel(h);
  } catch (e) {
    document.querySelector('main').innerHTML = `
      <div class="empty">
        <p style="font-size:18px;margin-bottom:12px">No analytics data found</p>
        <p>Run the engine first:</p>
        <p><code>make analytics</code></p>
      </div>`;
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const fmt = {
  tokens: n => n >= 1e9 ? (n/1e9).toFixed(1)+'B' : n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(0)+'K' : String(n),
  cost:   n => '$' + n.toFixed(2),
  date:   s => s ? new Date(s).toLocaleDateString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-',
  sid:    s => s.substring(0,8)+'â€¦',
};

function severity(session) {
  const a = session.anomalies || [];
  if (a.some(x => x.severity === 'high')) return 'red';
  if (a.some(x => x.severity === 'medium')) return 'yellow';
  return 'green';
}

// â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  const btn = (typeof event !== 'undefined' && event?.target?.classList?.contains('tab'))
    ? event.target
    : document.querySelector(`.tab[onclick*="'${id}'"]`);
  if (btn) btn.classList.add('active');
}

// â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderOverview() {
  const s = DATA.summary;

  // Stat cards
  const cards = [
    { label:'Sessions', value: s.session_count, cls:'blue' },
    { label:'Total Cost', value: fmt.cost(s.total_cost),
      cls: s.total_cost > (DATA.config?.thresholds?.cost_per_day||10) ? 'red' : 'green' },
    { label:'Total Tokens', value: fmt.tokens(s.total_tokens),
      cls: s.total_tokens > (DATA.config?.thresholds?.tokens_per_day||70000) ? 'yellow' : 'green' },
    { label:'Input Tokens', value: fmt.tokens(s.total_input_tokens), cls:'blue' },
    { label:'Cache Read', value: fmt.tokens(s.total_cache_read_tokens), cls:'green',
      sub: s.total_tokens > 0 ? Math.round(s.total_cache_read_tokens/s.total_tokens*100)+'% of total' : '' },
    { label:'Anomalies', value: DATA.sessions.reduce((acc,s)=>acc+(s.anomalies||[]).length,0),
      cls: 'red' },
  ];

  document.getElementById('stat-cards').innerHTML = cards.map(c => `
    <div class="card">
      <div class="card-label">${c.label}</div>
      <div class="card-value ${c.cls}">${c.value}</div>
      ${c.sub ? `<div class="card-sub">${c.sub}</div>` : ''}
    </div>`).join('');

  // Token breakdown donut
  const tokenCtx = document.getElementById('chart-tokens').getContext('2d');
  new Chart(tokenCtx, {
    type: 'doughnut',
    data: {
      labels: ['Input', 'Output', 'Cache Create', 'Cache Read'],
      datasets: [{
        data: [s.total_input_tokens, s.total_output_tokens, s.total_cache_create_tokens, s.total_cache_read_tokens],
        backgroundColor: ['#89b4fa','#a6e3a1','#f9e2af','#cba6f7'],
        borderWidth: 0,
      }]
    },
    options: { plugins: { legend: { labels: { color:'#cdd6f4', font:{size:11} } } },
      responsive:true, maintainAspectRatio:true }
  });

  // Top tools bar
  const tools = s.tool_totals;
  const toolNames = Object.keys(tools).slice(0,10);
  const toolCtx = document.getElementById('chart-tools').getContext('2d');
  new Chart(toolCtx, {
    type: 'bar',
    data: {
      labels: toolNames,
      datasets: [{ data: toolNames.map(t=>tools[t]),
        backgroundColor: '#89b4fa', borderRadius: 4 }]
    },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks:{color:'#6c7086'}, grid:{color:'#3a3a5c'} },
        y: { ticks:{color:'#cdd6f4', font:{size:11}}, grid:{display:false} }
      },
      responsive:true, maintainAspectRatio:true
    }
  });

  // Session cost bar
  const heavy = s.heaviest_sessions.slice(0,8);
  const sessCtx = document.getElementById('chart-sessions').getContext('2d');
  new Chart(sessCtx, {
    type: 'bar',
    data: {
      labels: heavy.map(h => fmt.sid(h.session_id)),
      datasets: [{
        label: 'Cost ($)',
        data: heavy.map(h=>h.total_cost),
        backgroundColor: heavy.map(h =>
          h.anomaly_count > 0 ? '#f38ba8' : '#a6e3a1'),
        borderRadius: 4,
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks:{color:'#cdd6f4',font:{size:11}}, grid:{display:false} },
        y: { ticks:{color:'#6c7086'}, grid:{color:'#3a3a5c'} }
      },
      responsive:true, maintainAspectRatio:true
    }
  });
}

// â”€â”€ Bottleneck Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderBottleneckOverview() {
  const bn = DATA.summary.bottleneck_summary;
  if (!bn) return;

  // Issue Distribution horizontal bar chart
  const issueTypes = ['tool_loop','large_tool_result','token_spike','repeated_file_read'];
  const issueLabels = ['Tool Loop','Large Tool Result','Token Spike','Repeated File Read'];
  const issueColors = ['#f38ba8','#fab387','#f9e2af','#89b4fa'];
  const issueCounts = issueTypes.map(t => (bn.issue_breakdown||{})[t] || 0);

  const bnIssCtx = document.getElementById('chart-bn-issues').getContext('2d');
  new Chart(bnIssCtx, {
    type: 'bar',
    data: {
      labels: issueLabels,
      datasets: [{ data: issueCounts,
        backgroundColor: issueColors, borderRadius: 4 }]
    },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks:{color:'#6c7086'}, grid:{color:'#3a3a5c'} },
        y: { ticks:{color:'#cdd6f4', font:{size:11}}, grid:{display:false} }
      },
      responsive:true, maintainAspectRatio:true
    }
  });

  // Sessions by Bottleneck Score bar chart
  const scored = DATA.sessions
    .filter(s => s.bottleneck_report)
    .sort((a,b) => (b.bottleneck_report.bottleneck_score||0) - (a.bottleneck_report.bottleneck_score||0))
    .slice(0, 10);

  const bnScCtx = document.getElementById('chart-bn-scores').getContext('2d');
  new Chart(bnScCtx, {
    type: 'bar',
    data: {
      labels: scored.map(s => fmt.sid(s.session_id)),
      datasets: [{
        label: 'Score',
        data: scored.map(s => s.bottleneck_report.bottleneck_score),
        backgroundColor: scored.map(s => {
          const sc = s.bottleneck_report.bottleneck_score;
          return sc >= 70 ? '#f38ba8' : sc >= 40 ? '#fab387' : '#a6e3a1';
        }),
        borderRadius: 4,
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks:{color:'#cdd6f4',font:{size:11}}, grid:{display:false} },
        y: { ticks:{color:'#6c7086'}, grid:{color:'#3a3a5c'}, max:100 }
      },
      responsive:true, maintainAspectRatio:true
    }
  });
}

// â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTimeline() {
  const sessions = DATA.sessions;
  const maxTokens = Math.max(...sessions.map(s=>s.total_tokens), 1);

  document.getElementById('timeline-rows').innerHTML = sessions.map(s => {
    const sev = severity(s);
    const pct = Math.max(2, Math.round(s.total_tokens / maxTokens * 100));
    return `
    <div class="tl-row" onclick="switchToTree('${s.session_id}')">
      <span style="color:var(--muted);font-size:11px">${fmt.date(s.start)}</span>
      <div class="tl-bar-wrap">
        <div class="tl-bar ${sev}" style="width:${pct}%"></div>
      </div>
      <span>${fmt.tokens(s.total_tokens)}</span>
      <span>${fmt.cost(s.total_cost)}</span>
      <span class="badge ${sev}">${sev === 'red' ? 'âš  Heavy' : sev === 'yellow' ? 'ã€œ Medium' : 'âœ“ Light'}</span>
    </div>`;
  }).join('');
}

// â”€â”€ Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let activeSession = null;

function switchToTree(sessionId) {
  activeSession = sessionId;
  showPanel('tree');
  document.querySelectorAll('.tab')[2].classList.add('active');
  document.querySelectorAll('.tab')[1].classList.remove('active');
  renderTree();
}

const ANOMALY_ADVICE = {
  kitchen_sink: {
    title: 'ğŸª£ Kitchen-Sink',
    threshold: '1ã‚»ãƒƒã‚·ãƒ§ãƒ³ 167K tokensè¶…',
    bad: ['ä¼šè©±ã‚’åˆ‡ã‚‰ãšè¤‡æ•°ã‚¿ã‚¹ã‚¯ã‚’è©°ã‚è¾¼ã‚€', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¸ã”ã¨Readï¼ˆå¿…è¦ãªè¡Œã ã‘ã§ã‚ˆã„ï¼‰', 'ãƒ‡ãƒãƒƒã‚°å¤±æ•—ãƒ­ã‚°ãŒè“„ç©ã—ç¶šã‘ã‚‹', 'é•·ã„èª¬æ˜æ–‡ã§æŒ‡ç¤ºã™ã‚‹'],
    fix: ['RAG: Grep/Globã§å¿…è¦ç®‡æ‰€ã®ã¿å–å¾—', '1ã‚¿ã‚¹ã‚¯=1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«åˆ†å‰²', '/compactã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åœ§ç¸®ã—ã¦ã‹ã‚‰ç¶šã‘ã‚‹', 'Few-shot: é•·ã„èª¬æ˜ã‚ˆã‚Šè‰¯ã„ä¾‹1ã¤ã‚’æç¤º'],
  },
  long_duration: {
    title: 'â± Long Duration',
    threshold: '10åˆ†è¶…ï¼ˆè¨­å®šå¤‰æ›´å¯ï¼‰',
    bad: ['1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¤‡æ•°ã‚¿ã‚¹ã‚¯ã‚’è©°ã‚è¾¼ã‚€', 'æ–¹é‡è»¢æ›ã‚’ç¹°ã‚Šè¿”ã—è©¦è¡ŒéŒ¯èª¤ãŒé•·å¼•ã'],
    fix: ['ã‚¿ã‚¹ã‚¯å®Œäº†ã”ã¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ‡æ–­', 'é‡è¦æƒ…å ±ã¯memory/ã¾ãŸã¯CLAUDE.mdã«æ›¸ãå‡ºã™', 'ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°: ç€æ‰‹å‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­è¨ˆã‚’è¡Œã†'],
  },
  repetition: {
    title: 'ğŸ” Repetition',
    threshold: 'åŒä¸€ãƒ„ãƒ¼ãƒ«100å›è¶…',
    bad: ['åŒã˜ã‚¨ãƒ©ãƒ¼ã§åŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’ç¹°ã‚Šè¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—ï¼‰', 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å¾®ä¿®æ­£ã—ãªãŒã‚‰ä½•åå›ã‚‚å®Ÿè¡Œ'],
    fix: ['3å›åŒã˜ã‚¨ãƒ©ãƒ¼â†’åœæ­¢ã—ã¦ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å¤‰ãˆã‚‹', 'Webæ¤œç´¢ãƒ»å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ ¹æœ¬åŸå› ã‚’èª¿æŸ»', 'PITFALLS.mdã§æ—¢çŸ¥ã®è§£æ±ºç­–ã‚’ç¢ºèª'],
  },
  high_cost: {
    title: 'ğŸ’¸ High Cost',
    threshold: '$5è¶…',
    bad: ['å˜ç´”ã‚¿ã‚¹ã‚¯ã«Opusã‚’ä½¿ã„ç¶šã‘ã‚‹', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªã„çŸ­å‘½ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é‡ç”£'],
    fix: ['å˜ç´”ã‚¿ã‚¹ã‚¯ã¯Haiku/Sonnetã«åˆ‡ã‚Šæ›¿ãˆ', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨ï¼ˆ94%ç¯€ç´„å¯èƒ½ï¼‰', 'make ccusage-reportã§æ—¥æ¬¡ã‚³ã‚¹ãƒˆç›£è¦–'],
  },
};

let _tipEl = null;
function showTip(chip) {
  const tip = chip.querySelector('.anomaly-tip');
  if (!tip) return;
  tip.style.display = 'block';
  const rect = chip.getBoundingClientRect();
  const tipH = tip.offsetHeight;
  const top = rect.top - tipH - 6 < 8
    ? rect.bottom + 6          // ä¸ŠãŒã¯ã¿å‡ºã™å ´åˆã¯ä¸‹ã«
    : rect.top - tipH - 6;
  const left = Math.min(rect.left, window.innerWidth - 316);
  tip.style.top  = top + 'px';
  tip.style.left = left + 'px';
  _tipEl = tip;
}
function hideTip() {
  if (_tipEl) { _tipEl.style.display = 'none'; _tipEl = null; }
}

function anomalyChip(a) {
  const adv = ANOMALY_ADVICE[a.type] || { title: a.type, threshold: a.detail, bad: [], fix: [] };
  const badHtml = adv.bad.map(b => `<li style="color:var(--red)">${b}</li>`).join('');
  const fixHtml = adv.fix.map(f => `<li style="color:var(--green)">${f}</li>`).join('');
  return `<span class="anomaly-chip ${a.severity}"
      onmouseenter="showTip(this)" onmouseleave="hideTip()">
    ${a.type}
    <div class="anomaly-tip">
      <div class="tip-title">${adv.title}</div>
      <div class="tip-threshold">é–¾å€¤: ${adv.threshold}</div>
      ${badHtml ? `<div class="tip-section" style="color:var(--red)">âŒ å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³</div><ul>${badHtml}</ul>` : ''}
      ${fixHtml ? `<div class="tip-section" style="color:var(--green)">âœ… å¯¾ç­–</div><ul>${fixHtml}</ul>` : ''}
    </div>
  </span>`;
}

function bnScoreClass(score) {
  return score >= 70 ? 'bn-high' : score >= 40 ? 'bn-medium' : 'bn-low';
}

function renderBottleneckReport(sess) {
  const br = sess.bottleneck_report;
  if (!br || br.bottleneck_score === 0) return '';

  const issueTypes = ['tool_loop','large_tool_result','token_spike','repeated_file_read'];
  const typeLabels = { tool_loop:'Tool Loop', large_tool_result:'Large Tool Result',
    token_spike:'Token Spike', repeated_file_read:'Repeated File Read' };
  const counts = br.issue_counts || {};

  // Issue count groups
  const groups = issueTypes
    .filter(t => counts[t])
    .map(t => {
      const issues = (br.issues||[]).filter(i => i.type === t).slice(0, 5);
      const details = issues.map(i =>
        `<div class="bn-detail">${i.detail}</div>`
      ).join('');
      return `<details class="bn-issue-group">
        <summary><span class="bn-issue-type ${t}">${typeLabels[t]}</span> x${counts[t]} issues</summary>
        ${details}
      </details>`;
    }).join('');

  // Top issues (sorted by severity priority)
  const severityOrder = { tool_loop:0, large_tool_result:1, token_spike:2, repeated_file_read:3 };
  const topIssues = (br.issues||[])
    .slice()
    .sort((a,b) => (severityOrder[a.type]||9) - (severityOrder[b.type]||9))
    .slice(0, 5);
  const topHtml = topIssues.length ? `
    <div class="bn-top-issues">
      <div class="bn-top-label">Top Issues</div>
      <ul>${topIssues.map(i => `<li>${i.detail}</li>`).join('')}</ul>
    </div>` : '';

  const uid = sess.session_id.substring(0,8);
  return `
  <div class="bn-report">
    <div class="bn-report-header" onclick="toggleBnReport(this)">
      <span class="bn-arrow">â–¶</span>
      <span>Bottleneck Report</span>
      <span style="margin-left:auto;font-size:11px;color:var(--${br.bottleneck_score>=70?'red':br.bottleneck_score>=40?'orange':'muted'})">
        score: ${br.bottleneck_score}/100
      </span>
    </div>
    <div class="bn-report-body" id="bn-body-${uid}">
      ${groups}
      ${topHtml}
    </div>
  </div>`;
}

function toggleBnReport(header) {
  const body = header.nextElementSibling;
  const arrow = header.querySelector('.bn-arrow');
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (arrow) arrow.classList.toggle('open', !isOpen);
}

function renderTree() {
  const sessions = DATA.sessions.filter(s => !activeSession || s.session_id === activeSession);

  document.getElementById('tree-root').innerHTML = sessions.map(sess => {
    const sev = severity(sess);
    const anomalies = (sess.anomalies||[]).map(anomalyChip).join(' ');

    // Bottleneck score badge
    const br = sess.bottleneck_report;
    const bnBadge = br && br.bottleneck_score > 0
      ? `<span class="bn-score-badge ${bnScoreClass(br.bottleneck_score)}">B:${br.bottleneck_score}</span>`
      : '';

    const messages = (sess.messages || []).filter(m => m.role === 'user').map((m,i) => {
      const toolList = [...new Set(m.tools||[])];
      const toolChips = toolList.map(t=>`<span class="tool-chip">${t}</span>`).join(' ');
      return `
        <div class="tree-node" style="background:var(--bg)">
          <div class="tree-header" onclick="toggleNode(this)">
            <span style="font-size:12px">Msg #${i+1}: ${m.text_preview ? m.text_preview.substring(0,60)+'â€¦' : '(empty)'}</span>
            <span class="val">${toolList.length} tools</span>
            <span class="val">${fmt.tokens(m.input_tokens + m.output_tokens)}</span>
            <span class="val">${fmt.cost(m.cost)}</span>
            <span class="tree-expand">â–¶</span>
          </div>
          <div class="tree-children">
            ${toolChips ? `<div style="padding:6px 4px">${toolChips}</div>` : ''}
            <div class="tree-leaf">
              <span>Input tokens</span><span></span><span class="val">${fmt.tokens(m.input_tokens)}</span>
            </div>
            <div class="tree-leaf">
              <span>Output tokens</span><span></span><span class="val">${fmt.tokens(m.output_tokens)}</span>
            </div>
          </div>
        </div>`;
    }).join('');

    // Bottleneck report section
    const bnReport = renderBottleneckReport(sess);

    return `
    <div class="tree-node">
      <div class="tree-header" onclick="toggleNode(this)">
        <span style="font-weight:600">${fmt.sid(sess.session_id)} &nbsp; ${anomalies} ${bnBadge}</span>
        <span class="val">${sess.message_count} msgs</span>
        <span class="val">${fmt.tokens(sess.total_tokens)}</span>
        <span class="val badge ${sev}">${fmt.cost(sess.total_cost)}</span>
        <span class="tree-expand">â–¶</span>
      </div>
      <div class="tree-children">
        ${bnReport}
        ${messages || '<div style="color:var(--muted);padding:8px">No messages</div>'}
      </div>
    </div>`;
  }).join('');
}

function toggleNode(header) {
  const children = header.nextElementSibling;
  const arrow = header.querySelector('.tree-expand');
  const isOpen = children.classList.contains('open');
  children.classList.toggle('open', !isOpen);
  if (arrow) arrow.classList.toggle('open', !isOpen);
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSettings() {
  const cfg = DATA?.config?.thresholds || {};
  const det = DATA?.config?.detection || {};
  document.getElementById('cfg-tokens').value   = cfg.tokens_per_day || 70000;
  document.getElementById('cfg-duration').value = cfg.duration_minutes || 10;
  document.getElementById('cfg-cost').value     = cfg.cost_per_day || 10;
  document.getElementById('cfg-rep').value      = det.repetition_threshold || 100;
  document.getElementById('settings-modal').classList.add('open');
}

function closeSettings() {
  document.getElementById('settings-modal').classList.remove('open');
}

function saveSettings() {
  if (!DATA) return;
  DATA.config.thresholds.tokens_per_day   = +document.getElementById('cfg-tokens').value;
  DATA.config.thresholds.duration_minutes = +document.getElementById('cfg-duration').value;
  DATA.config.thresholds.cost_per_day     = +document.getElementById('cfg-cost').value;
  DATA.config.detection.repetition_threshold = +document.getElementById('cfg-rep').value;

  // Re-render with new thresholds
  document.getElementById('stat-cards').innerHTML = '';
  renderOverview();
  closeSettings();

  // Show save hint
  alert('Settings applied.\nTo persist: save ~/.claude/analytics-config.json manually or re-run engine.');
}

// â”€â”€ Reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderReviews() {
  const reviews = (DATA && DATA.reviews) || [];
  const container = document.getElementById('reviews-list');
  if (!reviews.length) {
    container.innerHTML = `
      <div class="empty">
        <p style="font-size:18px;margin-bottom:12px">ğŸ“‹ No reviews yet</p>
        <p>Use <code>/review</code> in Claude Code to create a session review</p>
        <p style="margin-top:8px;font-size:12px">Or: <code>make review SESSION=&lt;session-id&gt;</code></p>
      </div>`;
    return;
  }
  container.innerHTML = reviews.map((r, i) => {
    const date = new Date(r.mtime * 1000).toLocaleDateString('ja-JP',
      {year:'numeric', month:'2-digit', day:'2-digit'});
    const mdHtml = (typeof marked !== 'undefined')
      ? marked.parse(r.content)
      : `<pre style="white-space:pre-wrap">${r.content}</pre>`;
    return `
    <div class="review-card">
      <div class="review-card-header" onclick="toggleReview(this)">
        <span class="review-card-title">ğŸ“‹ ${r.filename.replace('.md', '')}</span>
        <span class="review-card-date">${date}</span>
      </div>
      <div class="review-card-body" id="review-body-${i}">
        <div class="review-content">${mdHtml}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleReview(header) {
  header.nextElementSibling.classList.toggle('open');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function render() {
  renderOverview();
  renderBottleneckOverview();
  renderTimeline();
  renderTree();
  renderReviews();
}

loadData();
</script>
</body>
</html>
