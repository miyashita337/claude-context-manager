# /investigate <ISSUE_NUMBER>

引数: `/investigate <N>`（例: `/investigate 42`）

---

## 🚫 禁止事項（このコマンド実行中は絶対に行わない）

- コードの変更・編集
- `git commit` / `git push`
- PR の作成
- Issue へのコメント投稿

**目的は「調査・報告のみ」。実装は別コマンド（`/create-pr`）で行う。**

---

## 実行手順

### Step 1: Issue 取得

以下を実行して Issue の全情報を取得する:

```bash
gh issue view $ARGUMENTS --repo miyashita337/claude-context-manager \
  --json number,title,body,labels,assignees,milestone,state,comments
```

取得すべき情報:
- タイトル・本文（再現手順、期待動作、実際の動作）
- ラベル（`bug`, `enhancement`, `Critical`, `High`, `Low` 等）
- アサイン・マイルストーン
- コメント欄の補足情報

**ラベルから重大度を判定し、Step 2.5 の実施有無を決定する:**

| ラベル | 重大度 | Step 2.5 |
|--------|--------|----------|
| `Critical` | Critical（即時対応必須・障害・セキュリティ） | ✅ 必須 |
| `High` / `bug` | High（主要機能の不具合・リリースブロッカー） | ✅ 必須 |
| `Medium` / `enhancement` | Medium（軽微な不具合・機能改善） | ⚠️ 任意 |
| `Low` / `documentation` / `question` | Low（nice-to-have・将来検討） | ❌ スキップ |
| ラベルなし | 不明 → ユーザーに確認 | ⚠️ 任意 |

---

### Step 2: 関連コード調査

Task(Explore) エージェントを起動して以下を並行調査する:

```
Task(Explore): Issue の本文・タイトルに含まれるキーワード、ファイル名、関数名を
Grep/Glob で検索し、関連コードを特定する。
以下を報告すること:
1. 関連ファイル一覧（パス + 該当行番号）
2. 関連する関数・クラス・モジュール
3. 依存関係（import/require の連鎖）
4. 直近の変更履歴（git log --oneline -10 <file>）
```

調査観点:
- Issue が指摘する挙動の実装箇所
- 変更が波及しうる範囲
- 設定ファイル・環境変数の関与

---

### Step 2.5: 決定的検証（Critical / High のみ）

> **目的**: AI の推論・推測による「おそらく動く」判定を禁止し、
> 実行結果・値比較・画面確認による **決定的な証拠** のみで判定する。

#### 2.5-A: ユーザー主張のファクトチェック

Issue 本文の主張（バグの症状、期待値）が正しいか検証する。
**もし主張が誤っていると判断した場合は、根拠とともに明示的に指摘する。**

#### 2.5-B: 種別による検証アプローチ

Issue のタイプに応じて以下の検証を実施する:

**バグ・不具合の場合（非ブラウザ ファクトチェックフロー）:**

```
① Issue の再現手順を読む

② Issue に書かれた手順をそのまま実行する
   - Issue に明示的なコマンドがある場合: そのコマンドを実行する
   - ない場合: 問題箇所の関数・モジュールを直接実行する
     例: python3 -c "from <module> import <func>; print(repr(<func>(<args>)))"
   - make test-all は「再現手順のひとつ」として使う（これだけで完結させない）

③ 実際の出力・値・エラーを記録する（コマンドと出力をそのまま貼る）

④ ファクトチェック: Issue の主張と一致するか判定する

   ✅ 一致する場合  → VERIFIED として記録し、Step 3 へ進む
   ❌ 一致しない場合 → 以下を必ず実施する（スキップ禁止）:
      1. 実際に確認できた出力を正確に記述する
      2. Issue の記述と何が異なるかを明示する
      3. ユーザーに提示して意見を求める
         例: "Issue では○○というエラーが発生すると記載がありますが、
              実行結果では△△でした。認識を確認させてください。"
      4. ユーザーの返答を待ってから続行する（独断で進めない）
```

**ブラウザ・UI 系バグの場合（スクリーンショット検証フロー）:**

> **前提**: サーバーは起動済みとして進める。起動が必要な場合はユーザーに確認する。

```
[調査フェーズ: バグの存在確認]

① テスト対象の画面に遷移する
   - Issue に記載された再現手順 / URL / 操作を実行

② /ss でスクリーンショットを取得し、画像を確認する

③ ファクトチェック: Issue に記載されたバグと一致しているか判定する

   ✅ 一致する場合  → VERIFIED として記録し、Step 3 へ進む
   ❌ 一致しない場合 → 以下を必ず実施する（スキップ・見落とし・次に進むことは禁止）:
      1. スクリーンショットで実際に確認できた状態を正確に記述する
      2. Issue の記述と何が異なるかを明示する
      3. ユーザーに提示して意見を求める
         例: "Issue では○○と記載がありますが、スクリーンショットでは
              △△が確認されました。認識を確認させてください。"
      4. ユーザーの返答を待ってから続行する（独断で進めない）
```

> **Note**: After フロー（修正後の確認）は `/create-pr` コマンドで実施する。

**設定・環境系バグの場合:**
```bash
# ファイルの存在・内容を直接確認
[ -f "<path>" ] && echo "EXISTS" || echo "MISSING"
grep -c "<pattern>" <file>  # 件数で判定（0 か否か）
```

#### 2.5-C: 検証不要の場合

以下に該当する場合は、ユーザーに確認を求めてから検証方法を決定する:
- Issue がフィーチャーリクエスト・設計提案（再現する「バグ」がない）
- 検証のためのコード実行が環境を変更してしまう可能性がある
- 重大度が Medium 以下

**確認テンプレート:**
```
Issue #$ARGUMENTS は [フィーチャーリクエスト/設計提案] のため、
決定的検証が困難です。以下の方法で検証してよいでしょうか？
- [ ] 仕様書・ドキュメントとの照合
- [ ] ユーザーが示すユースケースのヒアリング
- [ ] 他の検証方法:（提案をお願いします）
```

#### 2.5-D: 検証結果の記録ルール

- ✅ **VERIFIED**: 実行出力・値の一致で確認済み（根拠コマンドと出力を記録）
- ❌ **REFUTED**: 実行結果が主張と異なる（差異を明示）
- ⚠️ **INCONCLUSIVE**: 検証を試みたが環境依存等で判定不能（理由を記録）
- 🔮 **INFERENCE ONLY**: 実行なし・推論のみ（**Critical/High では使用禁止**）

---

### Step 3: PITFALLS.md 確認

```bash
# Issue のキーワードで PITFALLS.md を検索
grep -i "<keyword_from_issue>" .claude/PITFALLS.md
```

確認観点:
- 同一・類似エラーのエントリが存在するか
- 過去の解決策が今回も適用可能か
- 「Prevention」セクションに今回の問題が示唆されているか

---

### Step 4: 過去 PR 確認

```bash
# 関連ファイルに触れた直近 PR を確認
gh pr list --repo miyashita337/claude-context-manager \
  --state all --limit 20 --json number,title,body,mergedAt,labels

# 特定ファイルの変更履歴
git log --oneline --follow -10 -- <related_file>
```

確認観点:
- 同一ファイル・機能を変更した直近 PR
- 類似の修正が過去に行われた際の方針
- リグレッションの可能性（修正→再発のパターン）

---

### Step 5: 調査レポート出力

以下のテンプレートで調査結果をユーザーに表示する:

---

```markdown
# 調査レポート: Issue #$ARGUMENTS

**タイトル**: {issue_title}
**重大度**: {Critical / High / Medium / Low}
**状態**: {Open / Closed}
**担当者**: {assignees or 未アサイン}

---

## TL;DR
{3行以内。問題の本質と調査で判明した最重要事項}

---

## 関連コード

| ファイル | 行番号 | 役割 |
|---------|--------|------|
| {path} | {L.XX} | {何をしているか} |

---

## 検証結果（Step 2.5）

| 検証項目 | 結果 | 根拠・実行コマンド |
|---------|------|------------------|
| {主張の再現} | ✅ VERIFIED / ❌ REFUTED / ⚠️ INCONCLUSIVE | `{command}` → `{output}` |
| {関連テスト} | ✅ / ❌ | `make test-all` → {pass/fail XX件} |

> **ファクトチェック**: {ユーザーの主張が正しければ「主張は正確」、誤りがあれば具体的に指摘}

---

## PITFALLS.md 照合

| エントリID | 類似度 | 備考 |
|-----------|--------|------|
| {GIT-001 等} | 高/中/低/なし | {今回への適用可否} |

---

## 過去 PR との関連

| PR# | タイトル | 関連度 | 備考 |
|-----|---------|--------|------|
| #{N} | {title} | 高/中/低 | {リグレッション可能性等} |

---

## 影響範囲

| 区分 | 内容 |
|------|------|
| 変更が必要なファイル（推定） | {list} |
| 影響を受ける機能 | {list} |
| テスト要否 | {make test-all / 追加テスト必要 / 不要} |

---

## 推奨アクション

1. {優先度1: 何をすべきか・なぜか}
2. {優先度2}
3. {優先度3}

> 調査レポート表示完了。このまま Step 6 へ進む。
```

---

### Step 6: 検証結果を評価し、自動移行 or 停止を判断する

Step 5 の調査レポートに含まれる **Step 2.5 の検証結果** を確認し、以下の分岐で処理する:

#### ✅ 全結果が VERIFIED または Step 2.5 スキップ（Medium/Low）の場合

自動的に create-pr ワークフローへ移行する。以下をユーザーに表示してから実行する:

```
調査完了。Issue #$ARGUMENTS の実装フェーズに移行します。
─────────────────────────────────────────
```

その後、`create-pr` コマンドファイル（`.claude/commands/create-pr.md`）に定義された
全ステップを Issue 番号 `$ARGUMENTS` を引数として実行する。

---

#### ❌ REFUTED（主張が事実と異なる）が 1 件でもある場合

**自動移行を停止し**、ユーザーに以下を提示して判断を求める:

```
⚠️ 自動移行を停止しました。

Issue #$ARGUMENTS の調査で、ユーザーの主張と異なる検証結果が出ました。

## REFUTED の内容
| 検証項目 | Issue の主張 | 実際の確認結果 |
|---------|-------------|--------------|
| {項目}   | {主張}       | {実際}        |

このまま実装フェーズに進んでもよいですか？
- [ ] はい → /create-pr $ARGUMENTS を実行します
- [ ] Issueの内容を修正してから進める
- [ ] 調査を追加する
```

---

#### ⚠️ INCONCLUSIVE（環境依存で判定不能）が 1 件でもある場合

**自動移行を停止し**、ユーザーに以下を提示して判断を求める:

```
⚠️ 自動移行を停止しました。

Issue #$ARGUMENTS の調査で、環境依存により判定できない項目があります。

## INCONCLUSIVE の内容
| 検証項目 | 判定不能の理由 |
|---------|--------------|
| {項目}   | {理由}        |

このまま実装フェーズに進んでもよいですか？
- [ ] はい（リスクを承知で進める）→ /create-pr $ARGUMENTS を実行します
- [ ] 環境を整備してから再調査する
```

---

## ⚖️ Step 2.5 導入のデメリット（設計メモ）

シニアエンジニアとの壁打ちで提起された「決定的検証」導入について、
メリットと **デメリット** を両面から整理する。

### メリット
- ハルシネーション防止: 「おそらく動く」判定を排除
- Lost in the Middle 対策: コンテキスト中盤の証拠を見落とすリスクを低減
- レポートの信頼性向上: 再現可能な根拠付きの調査結果

### デメリット・リスク

| デメリット | 深刻度 | 対策 |
|-----------|--------|------|
| **調査時間の大幅増加** | 高 | Critical/High のみに限定（本ファイルで実施済み） |
| **環境依存で検証が失敗するケースで誤判定** | 中 | INCONCLUSIVE ラベルで明示し、環境問題と機能問題を区別 |
| **フィーチャーリクエストに適用すると無意味な検証が発生** | 中 | 2.5-C でヒアリングへフォールバック |
| **検証コードが実行環境を副作用で変更するリスク** | 中 | 2.5-C で事前確認を義務化 |
| **テストが存在しない機能は決定的検証が不可能** | 低〜中 | INCONCLUSIVE + テスト追加を推奨アクションに記載 |
| **スクリーンショット判定はツール依存** | 低 | `/ss` 未使用時は文字列・値比較のみで代替 |

**結論**: Critical/High に絞ることでコスト増大を抑制しつつ、
最も誤判定が致命的なケースのみ決定的検証を義務付ける設計は合理的。
ただし「環境依存で INCONCLUSIVE」が続く場合はテスト環境整備を先行させることを推奨。
