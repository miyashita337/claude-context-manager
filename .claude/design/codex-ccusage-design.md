# Codex & ccusage Skills è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**Phase**: Phase 2 - è¨­è¨ˆ
**ä½œæˆæ—¥**: 2026-02-17
**ä¾å­˜**: Phase 1ï¼ˆèª¿æŸ»ãƒ»ç ”ç©¶ï¼‰å®Œäº†

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [Skill #1: /ccusage è¨­è¨ˆ](#skill-1-ccusage-è¨­è¨ˆ)
3. [Skill #2: /compact-analyzer è¨­è¨ˆ](#skill-2-compact-analyzer-è¨­è¨ˆ)
4. [Skill #3: /codex è¨­è¨ˆ](#skill-3-codex-è¨­è¨ˆ)
5. [SpecStoryçµ±åˆè¨­è¨ˆ](#specstoryçµ±åˆè¨­è¨ˆ)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥)
7. [å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­è¨ˆ](#å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­è¨ˆ)
8. [å®Ÿè£…ã¸ã®å¼•ãç¶™ãäº‹é …](#å®Ÿè£…ã¸ã®å¼•ãç¶™ãäº‹é …)

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### è¨­è¨ˆæ–¹é‡

**Phase 1èª¿æŸ»çµæœã«åŸºã¥ãæ±ºå®š**:
- âœ… **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ccusageï¼ˆ80%ã‚«ãƒãƒ¼ï¼‰+ ç‹¬è‡ªå®Ÿè£…ï¼ˆ20%ï¼‰
- âœ… **ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `npm install -g ccusage`ã§ã©ã“ã‹ã‚‰ã§ã‚‚å®Ÿè¡Œå¯èƒ½
- âœ… **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: ç„¡æ–™ãƒ„ãƒ¼ãƒ«å„ªå…ˆã€Codex CLIã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ$0-20/æœˆï¼‰

### ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /ccusage      â”‚                  â”‚  /compact-analyzer â”‚
â”‚  Skill         â”‚                  â”‚  Skill (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)â”‚
â”‚                â”‚                  â”‚                    â”‚
â”‚ - æ—¥æ¬¡åˆ†æ     â”‚                  â”‚ - compactæ¤œå‡º      â”‚
â”‚ - æœˆæ¬¡åˆ†æ     â”‚                  â”‚ - å·®åˆ†è¨ˆç®—         â”‚
â”‚ - ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ â”‚                  â”‚ - Kitchen-Sinkæ¤œå‡º â”‚
â”‚ - JSONå‡ºåŠ›     â”‚                  â”‚ - Lost-in-middle   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                     â”‚
         â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â–º ccusage CLI  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ (v18.0.5)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹                  â”‚
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                  â”‚ ~/.claude/projects/*.jsonl    â”‚
                  â”‚ .specstory/history/*.md       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  /codex Skill  â”‚
                  â”‚  (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)  â”‚
                  â”‚                â”‚
                  â”‚ - AIåˆ†æ       â”‚
                  â”‚ - ã‚³ãƒ¼ãƒ‰æ´å¯Ÿ   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ„ãƒ¼ãƒ«é¸æŠ

| ãƒ„ãƒ¼ãƒ« | ç”¨é€” | ã‚³ã‚¹ãƒˆ | å„ªå…ˆåº¦ |
|--------|------|--------|--------|
| **ccusage** | ãƒˆãƒ¼ã‚¯ãƒ³åˆ†æã€ã‚³ã‚¹ãƒˆè¨ˆç®— | $0 | å¿…é ˆ |
| **SpecStory** | ä¼šè©±å±¥æ­´ã€compactæ¤œå‡º | $0 | å¿…é ˆ |
| **ç‹¬è‡ªå®Ÿè£…** | compactå·®åˆ†ã€ç•°å¸¸æ¤œå‡º | $0 | æ¨å¥¨ |
| **Codex CLI** | AIé§†å‹•ã®åˆ†æ | $0-20/æœˆ | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ |

---

## Skill #1: /ccusage è¨­è¨ˆ

### æ¦‚è¦

ccusageãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸClaude Codeã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡åˆ†æã€‚

### YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼

```yaml
---
name: ccusage
description: Analyze Claude Code session token usage and costs using ccusage CLI
tools: Bash, Read, Grep
model: sonnet
---
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### ã‚¹ãƒ†ãƒƒãƒ—1: è¦æ±‚è§£æ

```
å…¥åŠ›: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒãƒ³ãƒ‰
ä¾‹: /ccusage daily --since 20260201
    /ccusage session --json

å‡¦ç†:
1. ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’ç‰¹å®šï¼ˆdaily/monthly/sessionï¼‰
2. ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚°ã‚’è§£æï¼ˆ--json, --since, --untilï¼‰
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ccusageã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

```bash
# åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³
ccusage daily [OPTIONS]
ccusage monthly [OPTIONS]
ccusage session [OPTIONS]

# ä¸»è¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³
-j, --json              # JSONå‡ºåŠ›
-s, --since YYYYMMDD    # é–‹å§‹æ—¥
-u, --until YYYYMMDD    # çµ‚äº†æ—¥
-p, --project NAME      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
-q, --jq 'QUERY'        # jqçµ±åˆ
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: çµæœè§£æ

```
JSONå‡ºåŠ›ã®å ´åˆ:
- jqã§é‡è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
- é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šï¼ˆé–¾å€¤: $5ä»¥ä¸Šï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãƒˆãƒƒãƒ—5ã‚’æŠ½å‡º

ãƒ†ãƒ¼ãƒ–ãƒ«å‡ºåŠ›ã®å ´åˆ:
- è¦–è¦šçš„ã«æ•´å½¢ã—ã¦è¡¨ç¤º
- é‡è¦ãªçµ±è¨ˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: åˆ†æãƒ»æ´å¯Ÿæä¾›

```
åˆ†æå†…å®¹:
1. ãƒˆãƒ¼ã‚¿ãƒ«ã‚³ã‚¹ãƒˆ
2. ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ï¼ˆInput/Output/Cacheï¼‰
3. é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç‰¹å®š
4. æœ€é©åŒ–ææ¡ˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: SpecStoryé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```
é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç™ºè¦‹æ™‚:
1. SpecStoryã§ä¼šè©±å†…å®¹ã‚’ç¢ºèª
2. ãªãœã‚³ã‚¹ãƒˆãŒé«˜ã‹ã£ãŸã‹ã‚’åˆ†æ
3. æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆã‚’æä¾›
```

#### ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

```markdown
## ccusage åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

### ã‚µãƒãƒªãƒ¼
- æœŸé–“: 2026-02-01 ã€œ 2026-02-17
- ç·ã‚³ã‚¹ãƒˆ: $107.09
- ç·ãƒˆãƒ¼ã‚¯ãƒ³: 215,257,240

### é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³
1. context-manager-main: $60.74 (139M tokens)
   - æ¨å¥¨: compactæ¤œå‡ºã‚’ç¢ºèª

### æœ€é©åŒ–ææ¡ˆ
- Cache Readä½¿ç”¨ç‡ãŒé«˜ã„ï¼ˆ95%ï¼‰â†’ è‰¯å¥½
- é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯compactã‚’æ¤œè¨
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾å‡¦ |
|--------|------|------|
| `command not found: ccusage` | æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `npm install -g ccusage`ã‚’ã‚¬ã‚¤ãƒ‰ |
| `No sessions found` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãªã— | `~/.claude/projects/`ã‚’ç¢ºèª |
| `Invalid date format` | æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£ | YYYYMMDDå½¢å¼ã‚’æ¡ˆå†… |

**PITFALLS.mdé€£æº**:
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã€PITFALLS.mdã‚’è‡ªå‹•æ¤œç´¢
- æ—¢çŸ¥ã®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Œã°è§£æ±ºç­–ã‚’æç¤º
- æ–°è¦ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã—ã¦æ¬¡å›ã«å‚™ãˆã‚‹

---

## Skill #2: /compact-analyzer è¨­è¨ˆ

### æ¦‚è¦

SpecStory Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã€compactæ¤œå‡ºã¨å·®åˆ†è¨ˆç®—ã‚’è¡Œã†ç‹¬è‡ªå®Ÿè£…ã€‚

### YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼

```yaml
---
name: compact-analyzer
description: Detect compact events and analyze token/content differences from SpecStory history
tools: Bash, Read, Grep, Python
model: sonnet
---
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### ã‚¹ãƒ†ãƒƒãƒ—1: SpecStoryãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º

```bash
# .specstory/history/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
find .specstory/history/ -name "*.md" -type f | sort -r
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: Compactæ¤œå‡º

```python
def detect_compact_events(md_file):
    """
    SpecStory Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰compactã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º

    æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³:
    - `compact_detected: true`
    - ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®æ€¥æ¿€ãªæ¸›å°‘
    """
    compacts = []
    with open(md_file) as f:
        content = f.read()

    # compact_detected ãƒ•ãƒ©ã‚°ã‚’æ¤œç´¢
    import re
    compact_matches = re.finditer(r'compact_detected:\s*(true|false)', content)

    # ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’æŠ½å‡º
    token_matches = re.finditer(r'total_tokens:\s*(\d+)', content)

    return {
        'compact_detected': any(m.group(1) == 'true' for m in compact_matches),
        'token_history': [int(m.group(1)) for m in token_matches]
    }
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: å·®åˆ†è¨ˆç®—

```python
def calculate_compact_diff(before_tokens, after_tokens):
    """
    Compactå‰å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³å·®åˆ†ã‚’è¨ˆç®—
    """
    diff = before_tokens - after_tokens
    ratio = after_tokens / before_tokens if before_tokens > 0 else 0

    return {
        'before': before_tokens,
        'after': after_tokens,
        'diff': diff,
        'reduction_ratio': 1 - ratio,
        'saved_tokens': diff
    }
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: Kitchen-Sink / Lost-in-the-Middle æ¤œå‡º

```python
# é–¾å€¤è¨­å®š
KITCHEN_SINK_THRESHOLD = 167000  # tokens
LOST_IN_MIDDLE_THRESHOLD = 100000  # tokens

def detect_issues(session_data):
    """
    Kitchen-Sink/Lost-in-the-Middleå•é¡Œã‚’æ¤œå‡º
    """
    total_tokens = session_data['total_tokens']
    duration_minutes = session_data['duration_ms'] / 60000

    issues = []

    # Kitchen-Sinkæ¤œå‡ºï¼ˆé«˜ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ï¼‰
    if total_tokens > KITCHEN_SINK_THRESHOLD:
        issues.append({
            'type': 'kitchen_sink',
            'tokens': total_tokens,
            'severity': 'high' if total_tokens > 200000 else 'medium'
        })

    # Lost-in-the-Middleæ¤œå‡ºï¼ˆé•·æ™‚é–“ + ä¸­ç¨‹åº¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
    if total_tokens > LOST_IN_MIDDLE_THRESHOLD and duration_minutes > 30:
        issues.append({
            'type': 'lost_in_middle',
            'tokens': total_tokens,
            'duration_minutes': duration_minutes,
            'severity': 'medium'
        })

    return issues
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

```markdown
## Compactåˆ†æãƒ¬ãƒãƒ¼ãƒˆ

### ã‚»ãƒƒã‚·ãƒ§ãƒ³: 2026-02-16_07-19-30Z-context-manager

**Compactã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡º**: âœ… æ¤œå‡º

**ãƒˆãƒ¼ã‚¯ãƒ³æ¨ç§»**:
- Compactå‰: 167,340 tokens
- Compactå¾Œ: 81,340 tokens
- å‰Šæ¸›é‡: 86,000 tokens (51.4%å‰Šæ¸›)

**å¤±ã‚ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹æƒ…å ±**:
- ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœã®è©³ç´°
- ä¸­é–“çš„ãªä¼šè©±ã®æ–‡è„ˆ
- ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›

**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
- é‡è¦ãªæƒ…å ±ã¯æ—©ã‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
- é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯åˆ†å‰²ã‚’æ¤œè¨
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾å‡¦ |
|--------|------|------|
| `SpecStory directory not found` | `.specstory/`ãªã— | `specstory sync`å®Ÿè¡Œã‚’æ¡ˆå†… |
| `No compact events detected` | compactã‚¤ãƒ™ãƒ³ãƒˆãªã— | æ­£å¸¸ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ï¼‰ |
| `Invalid Markdown format` | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£ | SpecStoryãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª |

---

## Skill #3: /codex è¨­è¨ˆ

### æ¦‚è¦

OpenAI Codex CLIã‚’ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰ã€‚

### YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼

```yaml
---
name: codex
description: Analyze codebase using OpenAI Codex CLI (requires OpenAI API key)
tools: Bash, Read
model: sonnet
---
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ç¢ºèª

```bash
# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
codex login status

# æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
if [[ $? -ne 0 ]]; then
    echo "âŒ Codex CLI is not authenticated"
    echo "Run: codex login"
    exit 1
fi
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æ

```bash
# éã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–å®Ÿè¡Œ
codex exec "Analyze this codebase and suggest improvements for token efficiency"

# ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
codex review --files "src/**/*.py"
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: çµæœçµ±åˆ

```
Codexåˆ†æçµæœã¨ccusageãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ:
1. ccusageã§é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
2. Codexã§ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰å“è³ªã‚’åˆ†æ
3. æœ€é©åŒ–ææ¡ˆã‚’ç”Ÿæˆ
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾å‡¦ |
|--------|------|------|
| `401 Unauthorized` | æœªãƒ­ã‚°ã‚¤ãƒ³ | `codex login`ã‚’æ¡ˆå†… |
| `API rate limit exceeded` | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | å¾…æ©Ÿæ™‚é–“ã‚’æ¡ˆå†… |
| `Budget exceeded` | äºˆç®—è¶…é | ä½¿ç”¨åœæ­¢ã‚’æ¨å¥¨ |

---

## SpecStoryçµ±åˆè¨­è¨ˆ

### ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹æˆ¦ç•¥

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰.specstory/ã‚’æ¤œç´¢
SPECSTORY_DIR=".specstory/history"

if [[ ! -d "$SPECSTORY_DIR" ]]; then
    echo "âš ï¸ SpecStory directory not found"
    echo "Run: specstory sync"
    exit 1
fi

# æœ€æ–°ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
LATEST_MD=$(find "$SPECSTORY_DIR" -name "*.md" -type f | sort -r | head -1)
```

### è§£ææˆ¦ç•¥

**Markdownè§£æ**:
```python
import re

def parse_specstory_markdown(md_file):
    """
    SpecStory Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
    """
    with open(md_file) as f:
        content = f.read()

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    session_id = re.search(r'<!-- Claude Code Session ([\w-]+)', content)
    compact_detected = re.search(r'compact_detected:\s*true', content)

    # ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±æŠ½å‡º
    tokens = re.findall(r'total_tokens:\s*(\d+)', content)

    return {
        'session_id': session_id.group(1) if session_id else None,
        'compact_detected': bool(compact_detected),
        'token_history': [int(t) for t in tokens]
    }
```

**JSONLè§£æ**ï¼ˆä»£æ›¿æ‰‹æ®µï¼‰:
```python
import json

def parse_claude_session_jsonl(jsonl_file):
    """
    Claude Codeå…¬å¼ã®JSONLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
    """
    events = []
    with open(jsonl_file) as f:
        for line in f:
            event = json.loads(line)
            events.append(event)

    # compactã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡º
    compacts = [e for e in events if e.get('type') == 'compact']

    return {
        'events': events,
        'compacts': compacts,
        'total_tokens': sum(e.get('usage', {}).get('total_tokens', 0) for e in events)
    }
```

### compactãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º

**æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³**:
1. **SpecStory Markdown**: `compact_detected: true`
2. **JSONL**: `{"type": "compact", ...}`
3. **ãƒˆãƒ¼ã‚¯ãƒ³æ¨ç§»**: æ€¥æ¿€ãªæ¸›å°‘ï¼ˆ30%ä»¥ä¸Šï¼‰

### compactå‰å¾Œã®å·®åˆ†è¨ˆç®—

```python
def calculate_compact_impact(events):
    """
    compactã‚¤ãƒ™ãƒ³ãƒˆå‰å¾Œã®å·®åˆ†ã‚’è¨ˆç®—
    """
    compact_indices = [i for i, e in enumerate(events) if e.get('type') == 'compact']

    impacts = []
    for idx in compact_indices:
        before_tokens = sum(e.get('usage', {}).get('total_tokens', 0)
                          for e in events[:idx])
        after_tokens = sum(e.get('usage', {}).get('total_tokens', 0)
                         for e in events[idx+1:])

        impacts.append({
            'index': idx,
            'before': before_tokens,
            'after': after_tokens,
            'diff': before_tokens - after_tokens,
            'reduction_ratio': (before_tokens - after_tokens) / before_tokens
        })

    return impacts
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

### éšå±¤çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```
Level 1: äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆPre-flight checksï¼‰
    â†“
Level 2: å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ï¼ˆRuntime errorsï¼‰
    â†“
Level 3: PITFALLS.mdæ¤œç´¢ï¼ˆKnown issuesï¼‰
    â†“
Level 4: ãƒªãƒˆãƒ©ã‚¤ãƒ»ä»£æ›¿æ‰‹æ®µï¼ˆFallbackï¼‰
    â†“
Level 5: ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šï¼ˆUser notificationï¼‰
```

### PITFALLS.mdçµ±åˆ

**ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ™‚**:
```bash
# PITFALLS.mdã‹ã‚‰æ—¢çŸ¥ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œç´¢
error_id=$(grep -l "$error_message" .claude/PITFALLS.md | \
           grep -o 'ERROR-[0-9]*' | head -1)

if [[ -n "$error_id" ]]; then
    echo "âœ… Known issue: $error_id"
    # è§£æ±ºç­–ã‚’è¡¨ç¤º
    grep -A 10 "^## $error_id" .claude/PITFALLS.md
fi
```

### ãƒªãƒˆãƒ©ã‚¤ãƒãƒªã‚·ãƒ¼

```yaml
retry_policy:
  max_attempts: 3
  backoff: exponential
  retry_on:
    - network_error
    - rate_limit
    - temporary_failure
  no_retry_on:
    - authentication_error
    - invalid_input
    - permission_denied
```

---

## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­è¨ˆ

### JSONå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```json
{
  "summary": {
    "tool": "ccusage",
    "version": "18.0.5",
    "timestamp": "2026-02-17T00:35:00Z",
    "analysis_type": "daily",
    "period": {
      "start": "2026-02-01",
      "end": "2026-02-17"
    }
  },
  "metrics": {
    "total_cost": 107.09,
    "total_tokens": 215257240,
    "input_tokens": 56777,
    "output_tokens": 21135,
    "cache_create_tokens": 9873205,
    "cache_read_tokens": 205306123
  },
  "high_cost_sessions": [
    {
      "session_id": "context-manager-main",
      "cost": 60.74,
      "tokens": 139814000,
      "compact_detected": true,
      "recommendation": "Consider breaking into smaller sessions"
    }
  ],
  "compact_events": [
    {
      "session_id": "60789946-5bac-4335-8861-9579b29b6bfa",
      "timestamp": "2026-02-16T07:19:30Z",
      "before_tokens": 167340,
      "after_tokens": 81340,
      "reduction": 86000,
      "reduction_ratio": 0.514
    }
  ]
}
```

### Markdownå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```markdown
# Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ç”Ÿæˆæ—¥æ™‚**: 2026-02-17 00:35:00
**åˆ†ææœŸé–“**: 2026-02-01 ã€œ 2026-02-17
**ãƒ„ãƒ¼ãƒ«**: ccusage v18.0.5

---

## ğŸ“Š ã‚µãƒãƒªãƒ¼

| æŒ‡æ¨™ | å€¤ |
|------|-----|
| ç·ã‚³ã‚¹ãƒˆ | $107.09 |
| ç·ãƒˆãƒ¼ã‚¯ãƒ³ | 215,257,240 |
| å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ | 56,777 |
| å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ | 21,135 |
| Cache Create | 9,873,205 |
| Cache Read | 205,306,123 |

---

## ğŸ”¥ é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³

### 1. context-manager-main
- **ã‚³ã‚¹ãƒˆ**: $60.74
- **ãƒˆãƒ¼ã‚¯ãƒ³**: 139,814,000
- **Compactæ¤œå‡º**: âœ… ã‚ã‚Š
- **æ¨å¥¨**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å°ã•ãåˆ†å‰²

---

## ğŸ“‰ Compactã‚¤ãƒ™ãƒ³ãƒˆ

### ã‚»ãƒƒã‚·ãƒ§ãƒ³: 60789946-5bac...
- **æ—¥æ™‚**: 2026-02-16 07:19:30Z
- **Compactå‰**: 167,340 tokens
- **Compactå¾Œ**: 81,340 tokens
- **å‰Šæ¸›é‡**: 86,000 tokens (51.4%)

---

## ğŸ’¡ æœ€é©åŒ–ææ¡ˆ

1. âœ… Cache Readä½¿ç”¨ç‡ãŒé«˜ã„ï¼ˆ95%ï¼‰â†’ è‰¯å¥½
2. âš ï¸ é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯compactãƒªã‚¹ã‚¯ â†’ åˆ†å‰²ã‚’æ¤œè¨
3. ğŸ’° é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ç¢ºèª â†’ SpecStoryã§èª¿æŸ»
```

---

## å®Ÿè£…ã¸ã®å¼•ãç¶™ãäº‹é …

### Phase 3: Codex Skillå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
.claude/skills/codex/
â”œâ”€â”€ SKILL.md           # æœ¬è¨­è¨ˆã«åŸºã¥ãå®Ÿè£…
â””â”€â”€ references/
    â””â”€â”€ examples.md    # ä½¿ç”¨ä¾‹
```

**å®Ÿè£…å„ªå…ˆåº¦**: ä½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰

**æ³¨æ„äº‹é …**:
- OpenAI APIã‚­ãƒ¼å¿…é ˆ
- äºˆç®—åˆ¶é™ï¼ˆ$0-20/æœˆï¼‰ã®å®Ÿè£…
- ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

### Phase 4: ccusage Skillå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
.claude/skills/ccusage/
â”œâ”€â”€ SKILL.md
â””â”€â”€ references/
    â””â”€â”€ command-reference.md
```

**å®Ÿè£…å„ªå…ˆåº¦**: é«˜ï¼ˆå¿…é ˆæ©Ÿèƒ½ï¼‰

**å®Ÿè£…è¦ä»¶**:
1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
2. æ—¥æ¬¡/æœˆæ¬¡/ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ãƒ¬ãƒãƒ¼ãƒˆ
3. JSONå‡ºåŠ›å¯¾å¿œ
4. jqçµ±åˆ
5. é«˜ã‚³ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡ºï¼ˆé–¾å€¤: $5ï¼‰
6. SpecStoryé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### compact-analyzer Skillå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
.claude/skills/compact-analyzer/
â”œâ”€â”€ SKILL.md
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ analyze_compact.py    # Pythonå®Ÿè£…
â””â”€â”€ references/
    â””â”€â”€ algorithm.md
```

**å®Ÿè£…å„ªå…ˆåº¦**: ä¸­ï¼ˆæ¨å¥¨æ©Ÿèƒ½ï¼‰

**å®Ÿè£…è¦ä»¶**:
1. SpecStory Markdownè§£æ
2. compactæ¤œå‡ºï¼ˆ`compact_detected: true`ï¼‰
3. ãƒˆãƒ¼ã‚¯ãƒ³å·®åˆ†è¨ˆç®—
4. Kitchen-Sinkæ¤œå‡ºï¼ˆé–¾å€¤: 167K tokensï¼‰
5. Lost-in-the-middleæ¤œå‡º

---

## è¨­è¨ˆå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ±ºå®šï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
- [x] Skill #1ï¼ˆ/ccusageï¼‰è¨­è¨ˆå®Œäº†
- [x] Skill #2ï¼ˆ/compact-analyzerï¼‰è¨­è¨ˆå®Œäº†
- [x] Skill #3ï¼ˆ/codexï¼‰è¨­è¨ˆå®Œäº†
- [x] SpecStoryçµ±åˆæˆ¦ç•¥æ±ºå®š
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥å®šç¾©
- [x] å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­è¨ˆå®Œäº†
- [x] å®Ÿè£…ã¸ã®å¼•ãç¶™ãäº‹é …æ–‡æ›¸åŒ–

---

**æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3ï¼ˆCodex Skillå®Ÿè£…ï¼‰ã€Phase 4ï¼ˆccusage Skillå®Ÿè£…ï¼‰

**è¨­è¨ˆå®Œäº†æ—¥**: 2026-02-17
**è¦‹ç©æ™‚é–“**: 2-3æ™‚é–“
