# SpecStory 統合調査レポート

**調査日**: 2026-02-16
**担当タスク**: Task #4 - Phase 1: SpecStory統合調査

---

## 📦 インストール情報

### SpecStory
- **バージョン**: 1.6.0
- **インストール方法**: `npm install -g specstory`
- **コマンド**: `specstory`
- **公式サイト**: [SpecStory](https://specstory.com/claude-code)
- **GitHub**: [specstoryai/getspecstory](https://github.com/specstoryai/getspecstory)

### 対応エージェント
- ✅ Claude Code (`claude`)
- ✅ Codex CLI (`codex`)
- ✅ Cursor CLI (`cursor`)
- ✅ Factory Droid CLI (`droid`)
- ✅ Gemini CLI (`gemini`)

---

## 🎯 主要機能

### 1. コマンド

```bash
# エージェントのインストール確認
specstory check

# エージェントを実行（自動保存付き）
specstory run [agent-name]
specstory run claude

# 過去のセッションをMarkdownに変換
specstory sync
specstory sync -s <session-id>

# エージェントのアクティビティを監視（自動保存）
specstory watch

# セッション一覧表示
specstory list [agent-name]

# SpecStory Cloudにログイン/ログアウト
specstory login
specstory logout
```

### 2. 主要な使用例

```bash
# 現在のプロジェクトで Claude Code を実行（自動保存）
specstory run claude

# 過去の全セッションをMarkdownに変換
specstory sync

# リアルタイム監視（新しいセッションを自動保存）
specstory watch
```

---

## 📁 ファイル構造

### ディレクトリ構造

```
プロジェクトルート/
├── .specstory/
│   ├── .project.json          # プロジェクトメタデータ
│   └── history/               # Markdown履歴ファイル
│       └── YYYY-MM-DD_HH-MM-SSZ-[project-name].md
```

### .project.json

```json
{
  "workspace_id": "e41c-8227-9c9e-023f",
  "workspace_id_at": "2026-02-16T08:58:16Z",
  "git_id": "3a2d-fd9f-98f9-910b",
  "git_id_at": "2026-02-16T08:58:16Z",
  "project_name": "claude-context-manager"
}
```

---

## 📄 Markdown ファイルフォーマット

### ヘッダー

```markdown
<!-- Generated by SpecStory, Markdown v2.1.0 -->

# 2026-02-16 07:19:30Z

<!-- Claude Code Session 7d37850d-37ff-4c80-819a-4fe627ea7415 (2026-02-16 07:19:30Z) -->
```

### メッセージフォーマット

```markdown
_**User (2026-02-16 07:19:30Z)**_

[ユーザーメッセージ内容]

---

_**Agent (claude-sonnet-4-5-20250929 2026-02-16 07:19:42Z)**_

[Claudeの応答内容]
```

### トークン情報（検出された箇所）

```xml
<usage>total_tokens: 81340
user_tokens: 1200
assistant_tokens: 4220
duration_ms: 100017</usage>
```

または

```yaml
total_tokens: 5420
user_tokens: 1200
assistant_tokens: 4220
compact_detected: false
```

---

## 🎯 ユーザー要件への対応

### 元の要件

> SpecStoryで出力したClaude会話履歴をみて
> - 自動compactされるトークン量
> - compactトリガー条件
> - compact前後の差分
> - キッチンシンク/Lost-in-the-middle問題時のコンテキスト長

### SpecStoryで対応できる部分

| 要件 | SpecStory対応 | 詳細 |
|------|---------------|------|
| **トークン量記録** | ✅ 完全対応 | `total_tokens`, `user_tokens`, `assistant_tokens` |
| **compact検出** | ✅ 対応 | `compact_detected: false/true` フラグ |
| **compactトリガー条件** | ⚠️ 間接的 | トークン数から推定可能 |
| **compact前後の差分** | ⚠️ 部分対応 | 会話内容は記録されているが、差分計算は独自実装 |
| **コンテキスト長測定** | ✅ 対応 | `total_tokens`で測定 |
| **Kitchen-Sink検出** | ✅ 対応 | `total_tokens`が閾値超過で判定 |
| **Lost-in-the-middle検出** | ⚠️ 間接的 | トークン数とセッション時間から推定 |

---

## 🔍 データソース

### Claude Code セッションファイル

SpecStoryは以下から情報を取得：

```bash
# Claude Code公式セッションパス
~/.claude/projects/[project-path]/[session-id].jsonl
```

### 変換プロセス

```
JSONL (Claude Code) → SpecStory → Markdown (.specstory/history/)
```

---

## 📊 統合戦略

### ccusage + SpecStory 統合

| ツール | データソース | 主要機能 | 出力 |
|--------|-------------|----------|------|
| **ccusage** | `~/.claude/projects/*.jsonl` | トークン分析、コスト計算 | テーブル、JSON |
| **SpecStory** | `~/.claude/projects/*.jsonl` | 会話履歴保存、トークン記録 | Markdown |

**両者の関係**:
- **同じデータソース**を使用（`~/.claude/projects/`）
- **ccusage**: 定量分析（数値、統計）
- **SpecStory**: 定性分析（会話内容、文脈）

### 統合の利点

1. **ccusageでトークン分析** → 高コストセッションを特定
2. **SpecStoryで会話内容確認** → なぜコストが高かったかを理解
3. **compact検出** → SpecStoryの`compact_detected`フラグ
4. **差分計算** → SpecStory Markdownから独自実装

---

## 🎨 Skill統合設計

### Skill #1: `/ccusage` - トークン分析

```bash
# 基本分析
ccusage daily --since 20260201
ccusage session --json | jq
```

### Skill #2: `/specstory-sync` - 履歴同期

```bash
# 過去のセッションを全てMarkdownに変換
specstory sync

# 特定のセッションのみ
specstory sync -s <session-id>
```

### Skill #3: `/compact-analyzer` - 独自実装

**機能**:
1. SpecStory Markdownを解析
2. `compact_detected: true`のセッションを検出
3. compact前後のトークン数を比較
4. 会話内容の差分を計算

**実装例**:
```python
import re

def analyze_compact_events(md_file):
    """SpecStory Markdownからcompact情報を抽出"""
    with open(md_file) as f:
        content = f.read()

    # compact_detected フラグを検索
    compact_match = re.search(r'compact_detected:\s*(true|false)', content)

    # トークン情報を抽出
    token_match = re.search(r'total_tokens:\s*(\d+)', content)

    return {
        'compact_detected': compact_match.group(1) == 'true' if compact_match else False,
        'total_tokens': int(token_match.group(1)) if token_match else None
    }
```

---

## 🔧 実装プラン

### Phase 1: 基本統合

1. **ccusage Skill実装**
   - 日次/月次/セッション別レポート
   - JSON出力 + jq統合
   - 高コストセッション検出

2. **SpecStory連携**
   - `specstory sync`で履歴同期
   - Markdown読み込み
   - トークン情報抽出

### Phase 2: 高度な分析（オプション）

1. **Compact分析**
   - `compact_detected`フラグ検出
   - compact前後の差分計算
   - 失われた情報のハイライト

2. **Kitchen-Sink / Lost-in-the-middle 検出**
   - トークン閾値チェック（167K tokens）
   - セッション時間分析
   - 異常パターン検出

---

## 📋 使用例

### 例1: セッション履歴をMarkdownに変換

```bash
# 現在のプロジェクトのセッションを全て変換
cd /path/to/project
specstory sync

# 結果確認
ls .specstory/history/
```

### 例2: 特定のセッションを分析

```bash
# 1. ccusageで高コストセッションを特定
ccusage session --json | jq '.entries[] | select(.cost > 10) | .session'

# 2. SpecStoryでセッションIDを確認
specstory list claude

# 3. 特定のセッションをMarkdownに変換
specstory sync -s <session-id>

# 4. Markdownファイルを確認
cat .specstory/history/<session-file>.md
```

### 例3: compact検出

```bash
# SpecStory Markdownからcompact検出
grep "compact_detected: true" .specstory/history/*.md
```

### 例4: トークン使用量の推移を分析

```bash
# 1. ccusageで日次トークン使用量を取得
ccusage daily --since 20260201 --json > tokens.json

# 2. jqで分析
cat tokens.json | jq '.entries[] | {date, total: .totalTokens, cost}'

# 3. SpecStoryでコンテキストを確認
specstory sync
```

---

## ⚠️ 制限事項

### SpecStory

1. **リアルタイム監視の制限**
   - `specstory watch`は実行中のセッションのみ監視
   - 過去のセッションは`specstory sync`で変換が必要

2. **トークン情報の精度**
   - SpecStoryは推定値を使用している可能性
   - ccusageの方が正確なトークン計算

3. **Compact検出の精度**
   - `compact_detected`フラグの信頼性は要検証
   - Claude Codeの公式compact通知に依存

### 統合上の課題

1. **データソースの一貫性**
   - ccusageとSpecStoryが同じJSONLを参照しているか確認が必要
   - タイムスタンプのズレの可能性

2. **compact差分計算**
   - SpecStoryはcompact後のMarkdownを生成
   - compact前の完全な会話内容が失われている可能性

---

## 🚀 次のステップ

### Task #5: 調査ドキュメント作成

1. **統合調査レポート作成**
   - Task #1-4の結果をまとめる
   - Skill設計への適用方法を文書化

### Phase 2: Skill設計

1. **`/ccusage` Skill設計**
2. **`/specstory-sync` Skill設計**（オプション）
3. **`/compact-analyzer` Skill設計**（オプション）

---

## 📚 参考リンク

- [SpecStory - Claude Code](https://docs.specstory.com/integrations/claude-code)
- [SpecStory CLI](https://specstory.com/claude-code)
- [SpecStory GitHub](https://github.com/specstoryai/getspecstory)
- [ccusage GitHub](https://github.com/ryoppippi/ccusage)

---

## ✅ 調査完了

**SpecStoryは優れた会話履歴管理ツール**で、トークン情報とcompact検出フラグを含んでいます。ccusageとの統合により、**定量分析と定性分析の両方**が可能になります。

**推奨統合方法**: ccusage（トークン分析）+ SpecStory（会話内容）+ 独自実装（compact差分計算）

---

**調査完了日**: 2026-02-16
**次のタスク**: Task #5（調査ドキュメント作成）
