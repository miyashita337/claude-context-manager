name: Tests

on:
  push:
    branches: [ main, develop, "feature/**" ]
  pull_request:
    branches: [ main, develop, "feature/**" ]
  workflow_dispatch:

jobs:
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Run Python tests
      run: |
        pytest tests/ -v --cov=src/hooks --cov=src/session-title --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: python
        name: python-${{ matrix.python-version }}
      continue-on-error: true

  typescript-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript tests
      run: npm test -- --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/coverage-final.json
        flags: typescript
        name: typescript-${{ matrix.node-version }}
      continue-on-error: true

  startup-check:
    name: Startup Check (Automated)
    runs-on: ubuntu-latest
    needs: [python-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Create mock .claude directory
      run: |
        mkdir -p ~/.claude/context-history/.tmp
        mkdir -p ~/.claude/context-history/sessions
        mkdir -p ~/.claude/context-history/archives
        mkdir -p ~/.claude/context-history/.metadata

    - name: Run startup check (skip tests)
      run: |
        export SKIP_TESTS=1
        bash scripts/startup-check.sh

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-tests, typescript-tests, startup-check]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install all dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        npm ci

    - name: Run full test suite
      run: |
        npm run test:all

    - name: Verify test outputs
      run: |
        echo "All tests completed successfully!"
        echo "Python tests: ✓"
        echo "TypeScript tests: ✓"
        echo "Integration tests: ✓"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [python-tests, typescript-tests, startup-check, integration-tests]
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.python-tests.result }}" != "success" ] || \
           [ "${{ needs.typescript-tests.result }}" != "success" ] || \
           [ "${{ needs.startup-check.result }}" != "success" ] || \
           [ "${{ needs.integration-tests.result }}" != "success" ]; then
          echo "❌ Some tests failed"
          exit 1
        else
          echo "✅ All tests passed"
        fi
